# Plan: v0.8.0 - Distribution Ready

## Summary

Make the Reclaim MCP Server production-ready for public distribution with:
1. **Tool Profiles** - Allow users to enable minimal/standard/full tool sets
2. **GitLab CI Release Pipeline** - Automated build and publish on tag
3. **Python Distribution** - PyPI + GitLab Package Registry
4. **Docker Distribution** - GitLab Container Registry + Docker Hub

---

## Part 1: Tool Profiles

### New Environment Variable
```
RECLAIM_TOOL_PROFILE=full  # Options: minimal, standard, full (default)
```

### Profile Definitions

| Profile | Tools | Description |
|---------|-------|-------------|
| `minimal` | 20 | Core tasks + habits basics |
| `standard` | 33 | Core productivity (no niche tools) |
| `full` | 42 | All tools (default) |

### Tools by Profile

**Minimal (20 tools)**:
- Tasks: list_tasks, create_task, update_task, mark_task_complete, delete_task, get_task, list_completed_tasks
- Habits: list_habits, create_habit, update_habit, delete_habit, mark_habit_done, skip_habit
- Events: list_events, list_personal_events, get_event
- Focus: get_focus_settings
- System: health_check, verify_connection
- Analytics: get_user_analytics

**Standard (33 tools)** - adds:
- Tasks: add_time_to_task, start_task, stop_task, prioritize_task, restart_task
- Habits: enable_habit, disable_habit
- Focus: update_focus_settings, lock_focus_block, unlock_focus_block, reschedule_focus_block
- Analytics: get_focus_insights

**Full (42 tools)** - adds:
- Events: pin_event, unpin_event, set_event_rsvp, move_event
- Habits: lock_habit_instance, unlock_habit_instance, start_habit, stop_habit, convert_event_to_habit

### Implementation

**File: `src/reclaim_mcp/config.py`**
```python
class Settings(BaseSettings):
    api_key: str
    base_url: str = "https://api.app.reclaim.ai"
    tool_profile: str = "full"  # NEW
```

**File: `src/reclaim_mcp/profiles.py`** (NEW)
```python
MINIMAL_TOOLS = {...}  # 20 tool names
STANDARD_TOOLS = {...}  # 33 tool names
FULL_TOOLS = {...}      # 42 tool names

PROFILES = {
    "minimal": MINIMAL_TOOLS,
    "standard": STANDARD_TOOLS,
    "full": FULL_TOOLS,
}

def is_tool_enabled(tool_name: str, profile: str = "full") -> bool:
    return tool_name in PROFILES.get(profile, FULL_TOOLS)
```

**File: `src/reclaim_mcp/server.py`**
- Add conditional registration based on profile
- Option A: Check profile before each `@mcp.tool` registration
- Option B: Register all, then filter at startup

---

## Part 2: GitLab CI Release Pipeline

### Pipeline Flow

```
build-python ─→ publish-gitlab ─→ publish-pypi ─┐
                                                 ├→ create-release
build-docker ─→ publish-docker-gitlab ─→ publish-docker-hub ─┘
```

### Dual Publishing Strategy

| Artifact | Registry | Purpose | Authentication |
|----------|----------|---------|----------------|
| Python Package | GitLab Package Registry | Internal/backup | `CI_JOB_TOKEN` (auto) |
| Python Package | PyPI | Public distribution | `PYPI_TOKEN` |
| Docker Image | GitLab Container Registry | Internal/backup | `CI_JOB_TOKEN` (auto) |
| Docker Image | Docker Hub | Public distribution | `DOCKERHUB_TOKEN` |

### New CI/CD Variables (GitLab Settings)

| Variable | Type | Description |
|----------|------|-------------|
| `PYPI_TOKEN` | Protected, Masked | PyPI API token for publishing |
| `DOCKERHUB_USERNAME` | Protected | Docker Hub username |
| `DOCKERHUB_TOKEN` | Protected, Masked | Docker Hub access token |
| `CI_JOB_TOKEN` | Auto-provided | GitLab registries (no config needed) |

### New `.gitlab-ci.yml` Stage

```yaml
stages:
  - lint
  - test
  - security
  - release  # NEW

# === Release Stage (tag-triggered only) ===

.release-rules:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# --- Python Package Jobs ---

build-python:
  stage: release
  extends:
    - .poetry-setup
    - .release-rules
  script:
    - poetry build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

publish-gitlab:
  stage: release
  extends:
    - .poetry-setup
    - .release-rules
  needs: [build-python]
  script:
    - pip install twine
    - |
      TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token \
        twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi \
        dist/*.whl dist/*.tar.gz

publish-pypi:
  stage: release
  extends:
    - .poetry-setup
    - .release-rules
  needs: [publish-gitlab]
  script:
    - pip install twine
    - twine upload dist/* -u __token__ -p ${PYPI_TOKEN}

# --- Docker Image Jobs ---

build-docker:
  stage: release
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  extends: .release-rules
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker buildx create --use
    - docker buildx build
        --platform linux/amd64,linux/arm64
        --tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG#v}
        --tag ${CI_REGISTRY_IMAGE}:latest
        --file Dockerfile
        --push .
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}

publish-docker-hub:
  stage: release
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  extends: .release-rules
  needs: [build-docker]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKERHUB_REPO: "universalamateur/reclaim-mcp-server"
  script:
    - docker buildx create --use
    - docker buildx build
        --platform linux/amd64,linux/arm64
        --tag ${DOCKERHUB_REPO}:${CI_COMMIT_TAG#v}
        --tag ${DOCKERHUB_REPO}:latest
        --file Dockerfile
        --push .
  before_script:
    - docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_TOKEN}

# --- Release Job ---

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  extends: .release-rules
  needs: [publish-pypi, publish-docker-hub]
  script:
    - echo "Creating release ${CI_COMMIT_TAG}"
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "Release ${CI_COMMIT_TAG}"
    description: |
      ## Installation

      ### Python
      ```bash
      pip install reclaim-mcp-server==${CI_COMMIT_TAG#v}
      ```

      ### Docker
      ```bash
      docker pull universalamateur/reclaim-mcp-server:${CI_COMMIT_TAG#v}
      ```

      See [CHANGELOG.md](CHANGELOG.md) for details.
    assets:
      links:
        - name: "PyPI Package"
          url: "https://pypi.org/project/reclaim-mcp-server/${CI_COMMIT_TAG#v}/"
          link_type: package
        - name: "Docker Hub"
          url: "https://hub.docker.com/r/universalamateur/reclaim-mcp-server"
          link_type: image
        - name: "GitLab Container Registry"
          url: "${CI_PROJECT_URL}/container_registry"
          link_type: image
```

### Future Enhancement (v0.9.0+)

Package signing with Sigstore Cosign for supply chain security:
- Adds `sign` and `verify` stages
- Requires `id_tokens` for keyless signing
- Publishes `.sig` and `.crt` attestation files

---

## Part 3: Python Distribution

### Distribution Channels

| Channel | Type | Install Command |
|---------|------|-----------------|
| PyPI | Public | `pip install reclaim-mcp-server` |
| GitLab Package Registry | Internal/Backup | Project → Packages |
| Docker Hub | Public | `docker pull universalamateur/reclaim-mcp-server` |
| GitLab Container Registry | Internal/Backup | Project → Container Registry |
| Smithery.ai | MCP Registry | Manual submission |
| Glama | MCP Registry | Manual submission |

### PyPI Publication
- Package name: `reclaim-mcp-server`
- Install: `pip install reclaim-mcp-server` or `uvx reclaim-mcp-server`
- Entry point already configured in pyproject.toml

### GitLab Package Registry
- Auto-published on every release tag
- Install from GitLab (internal use):
  ```bash
  pip install reclaim-mcp-server --index-url https://__token__:<your_token>@gitlab.com/api/v4/projects/<project_id>/packages/pypi/simple
  ```
- Serves as backup if PyPI is unavailable
- Release evidence auto-generated

### Registry Listings (Manual)
1. **Smithery.ai** - Submit after PyPI publication
2. **Glama** - Submit after PyPI publication

### README Updates

- Add PyPI badge
- Add Docker Hub badge
- Add installation instructions: `pip install reclaim-mcp-server`
- Add Docker usage instructions
- Add tool profile documentation

---

## Part 4: Docker Distribution

### Image Strategy

| Aspect | Choice | Rationale |
|--------|--------|-----------|
| Base Image | `python:3.10-slim` → `distroless` | Minimal attack surface |
| Build | Multi-stage | Separate build/runtime dependencies |
| User | Non-root (`nonroot:nonroot`) | Security best practice |
| Platforms | `linux/amd64`, `linux/arm64` | Support x86 and Apple Silicon |
| Transport | stdio | MCP standard for containers |

### Dockerfile (NEW)

```dockerfile
# === Build Stage ===
FROM python:3.10-slim AS builder

WORKDIR /app

# Install poetry and build dependencies
RUN pip install --no-cache-dir poetry

# Copy dependency files
COPY pyproject.toml poetry.lock ./

# Export dependencies to requirements.txt (no dev deps)
RUN poetry export -f requirements.txt --without-hashes -o requirements.txt

# Copy source code
COPY src/ src/

# Build wheel
RUN poetry build -f wheel

# === Runtime Stage ===
FROM python:3.10-slim AS runtime

# Security: Create non-root user
RUN groupadd --gid 1000 nonroot && \
    useradd --uid 1000 --gid 1000 --shell /bin/false nonroot

WORKDIR /app

# Install only runtime dependencies
COPY --from=builder /app/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install the built wheel
COPY --from=builder /app/dist/*.whl .
RUN pip install --no-cache-dir *.whl && rm *.whl requirements.txt

# Security: Switch to non-root user
USER nonroot:nonroot

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "from reclaim_mcp import __version__; print(__version__)" || exit 1

# MCP servers use stdio transport
ENTRYPOINT ["reclaim-mcp-server"]
```

### Docker Registries

| Registry | Image Name | URL |
|----------|------------|-----|
| GitLab Container Registry | `registry.gitlab.com/universalamateur1/reclaim-mcp-server` | Project → Container Registry |
| Docker Hub | `universalamateur/reclaim-mcp-server` | hub.docker.com |

### Docker Usage

```bash
# Pull from Docker Hub
docker pull universalamateur/reclaim-mcp-server:latest

# Run with API key
docker run -e RECLAIM_API_KEY="your_key" universalamateur/reclaim-mcp-server

# Run with tool profile
docker run -e RECLAIM_API_KEY="your_key" -e RECLAIM_TOOL_PROFILE=minimal \
    universalamateur/reclaim-mcp-server
```

### Claude Desktop Configuration (Docker)

```json
{
  "mcpServers": {
    "reclaim": {
      "command": "docker",
      "args": [
        "run", "-i", "--rm",
        "-e", "RECLAIM_API_KEY",
        "universalamateur/reclaim-mcp-server:latest"
      ],
      "env": {
        "RECLAIM_API_KEY": "your_key_here"
      }
    }
  }
}
```

### Security Hardening Checklist

- [x] Multi-stage build (no build tools in runtime)
- [x] Non-root user
- [x] Minimal base image (python:slim)
- [x] No shell access needed
- [x] Health check endpoint
- [x] Multi-platform support (amd64/arm64)
- [ ] Future: Distroless base image (v0.9.0)
- [ ] Future: Image signing with Cosign (v0.9.0)

---

## Files to Modify

| File | Change |
|------|--------|
| `src/reclaim_mcp/config.py` | Add `tool_profile` field |
| `src/reclaim_mcp/profiles.py` | **CREATE** - profile definitions |
| `src/reclaim_mcp/server.py` | Conditional tool registration |
| `Dockerfile` | **CREATE** - multi-stage hardened image |
| `.dockerignore` | **CREATE** - exclude dev files from build |
| `.gitlab-ci.yml` | Add release stage (Python + Docker) |
| `README.md` | Add PyPI/Docker install, profile docs |
| `pyproject.toml` | Version bump to 0.8.0 |
| `src/reclaim_mcp/__init__.py` | Version bump |
| `tests/test_server.py` | Version assertion update |

---

## Order of Operations

### Phase 1: Tool Profiles

1. Create `profiles.py` with tool profile definitions
2. Update `config.py` with `tool_profile` setting
3. Update `server.py` for conditional registration
4. Add tests for profile loading

### Phase 2: Docker

5. Create `Dockerfile` (multi-stage, hardened)
6. Create `.dockerignore`
7. Test Docker build locally: `docker build -t reclaim-mcp-server .`
8. Test Docker run: `docker run -e RECLAIM_API_KEY=test reclaim-mcp-server`

### Phase 3: CI/CD Pipeline

9. Update `.gitlab-ci.yml` with release pipeline (Python + Docker)
10. Configure CI/CD variables in GitLab:
    - [ ] `PYPI_TOKEN`
    - [ ] `DOCKERHUB_USERNAME`
    - [ ] `DOCKERHUB_TOKEN`

### Phase 4: Documentation & Release

11. Update README with installation and profile docs
12. Bump version to 0.8.0 (3 locations + poetry lock)
13. Run full test suite and linting
14. Commit and tag v0.8.0

### Phase 5: Verification

15. Verify release pipeline:
    - [ ] GitLab Package Registry publication
    - [ ] PyPI publication
    - [ ] GitLab Container Registry publication
    - [ ] Docker Hub publication
    - [ ] GitLab Release created with assets
16. Submit to Smithery/Glama

---

## Testing

### Profile Tests

1. Unit tests for profile loading in `tests/test_profiles.py`
2. Verify each profile loads correct number of tools (20/33/42)
3. Test with `RECLAIM_TOOL_PROFILE=minimal` env var
4. Test invalid profile falls back to `full`

### Docker Tests

1. Build image locally: `docker build -t test-reclaim .`
2. Verify non-root user: `docker run test-reclaim whoami` → `nonroot`
3. Verify health check: `docker inspect --format='{{.State.Health.Status}}' <container>`
4. Test with API key: `docker run -e RECLAIM_API_KEY=test test-reclaim`
5. Test multi-platform: `docker buildx build --platform linux/amd64,linux/arm64 .`
6. Verify image size is reasonable (< 200MB target)

### Pipeline Tests

1. Test release jobs on branch before tagging (dry-run)
2. Verify `build-python` job creates wheel and sdist artifacts
3. Verify `build-docker` job creates multi-arch image
4. Test GitLab Package Registry upload with test tag (e.g., `v0.8.0-rc1`)
5. Test GitLab Container Registry push
6. Verify release evidence generation
