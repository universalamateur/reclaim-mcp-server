# Plan: v0.8.0 - Distribution Ready

## Summary

Make the Reclaim MCP Server production-ready for public distribution with:
1. **Tool Profiles** - Allow users to enable minimal/standard/full tool sets
2. **GitLab CI Release Pipeline** - Multi-registry publishing with OIDC Trusted Publishing
3. **Python Distribution** - PyPI + TestPyPI + GitLab Package Registry
4. **Docker Distribution** - GitLab Container Registry + Docker Hub

---

## Expert Recommendations Applied

| Original Approach | Expert Recommendation | Benefit |
|-------------------|----------------------|---------|
| `PYPI_TOKEN` secret | OIDC Trusted Publishing | No secrets to rotate/leak |
| Auto-trigger on tag | Manual publish triggers | Prevents accidental releases |
| Direct to PyPI | TestPyPI → PyPI flow | Pre-release validation |
| No environments | GitLab Environments | Track deployments |

**Reference:** `/Users/falko/git-personal/reclaim-mcp-publishing/RECOMMENDATION.md`

---

## Part 1: Tool Profiles

### New Environment Variable

```
RECLAIM_TOOL_PROFILE=full  # Options: minimal, standard, full (default)
```

### Profile Definitions

| Profile | Tools | Description |
|---------|-------|-------------|
| `minimal` | 20 | Core tasks + habits basics |
| `standard` | 33 | Core productivity (no niche tools) |
| `full` | 42 | All tools (default) |

### Tools by Profile

**Minimal (20 tools)**:
- Tasks: list_tasks, create_task, update_task, mark_task_complete, delete_task, get_task, list_completed_tasks
- Habits: list_habits, create_habit, update_habit, delete_habit, mark_habit_done, skip_habit
- Events: list_events, list_personal_events, get_event
- Focus: get_focus_settings
- System: health_check, verify_connection
- Analytics: get_user_analytics

**Standard (33 tools)** - adds:
- Tasks: add_time_to_task, start_task, stop_task, prioritize_task, restart_task
- Habits: enable_habit, disable_habit
- Focus: update_focus_settings, lock_focus_block, unlock_focus_block, reschedule_focus_block
- Analytics: get_focus_insights

**Full (42 tools)** - adds:
- Events: pin_event, unpin_event, set_event_rsvp, move_event
- Habits: lock_habit_instance, unlock_habit_instance, start_habit, stop_habit, convert_event_to_habit

### Implementation

**File: `src/reclaim_mcp/config.py`**

```python
class Settings(BaseSettings):
    api_key: str
    base_url: str = "https://api.app.reclaim.ai"
    tool_profile: str = "full"  # NEW
```

**File: `src/reclaim_mcp/profiles.py`** (NEW)

```python
MINIMAL_TOOLS = {...}  # 20 tool names
STANDARD_TOOLS = {...}  # 33 tool names
FULL_TOOLS = {...}      # 42 tool names

PROFILES = {
    "minimal": MINIMAL_TOOLS,
    "standard": STANDARD_TOOLS,
    "full": FULL_TOOLS,
}

def is_tool_enabled(tool_name: str, profile: str = "full") -> bool:
    return tool_name in PROFILES.get(profile, FULL_TOOLS)
```

**File: `src/reclaim_mcp/server.py`**
- Add conditional registration based on profile
- Option A: Check profile before each `@mcp.tool` registration
- Option B: Register all, then filter at startup

---

## Part 2: Multi-Registry Publishing

### Registry Overview

| Registry | Purpose | Auth Method |
|----------|---------|-------------|
| **PyPI** | Public Python package | OIDC Trusted Publishing (no secrets) |
| **TestPyPI** | Pre-release validation | OIDC Trusted Publishing (no secrets) |
| **GitLab Package Registry** | Internal/enterprise | Automatic (`$CI_JOB_TOKEN`) |
| **GitLab Container Registry** | Internal Docker images | Automatic (`$CI_REGISTRY_*`) |
| **DockerHub** | Public Docker images | Access token (1 secret) |

### Pipeline Flow

```
lint → test → security → build → publish

                    build-package ─────────────────────────────────┐
                          │                                        │
                    build-docker                                   │
                          │                                        │
    ┌─────────────────────┼─────────────────────────┐              │
    ↓                     ↓                         ↓              │
publish-gitlab    publish-testpypi          publish-gitlab    create-release
  -package          (manual)                 -container            ↑
                      │                           │                │
                      ↓                           ↓                │
                publish-pypi              publish-dockerhub ───────┘
                 (manual)                   (manual)
```

### CI/CD Variables Required

| Variable | Type | Source |
|----------|------|--------|
| `DOCKERHUB_USERNAME` | Protected | DockerHub account |
| `DOCKERHUB_TOKEN` | Protected, Masked | DockerHub → Security → Access Tokens |
| `CI_JOB_TOKEN` | Auto-provided | No configuration needed |

**Note**: No `PYPI_TOKEN` needed - OIDC Trusted Publishing handles PyPI/TestPyPI auth.

### GitLab Environments to Create

| Environment | URL | Purpose |
|-------------|-----|---------|
| `release-test` | https://test.pypi.org/project/reclaim-mcp-server/ | TestPyPI tracking |
| `release` | https://pypi.org/project/reclaim-mcp-server/ | Production PyPI |
| `docker` | https://hub.docker.com/r/universalamateur/reclaim-mcp-server | DockerHub tracking |

---

## Part 3: Implementation Files (Ready to Copy)

Expert has prepared ready-to-copy implementation files:

| Source File | Destination | Action |
|-------------|-------------|--------|
| `reclaim-mcp-publishing/implementation/Dockerfile` | `reclaim-mcp-server/Dockerfile` | **New file** |
| `reclaim-mcp-publishing/implementation/.dockerignore` | `reclaim-mcp-server/.dockerignore` | **New file** |
| `reclaim-mcp-publishing/implementation/.gitlab-ci.yml` | `reclaim-mcp-server/.gitlab-ci.yml` | **Replaces existing** |

The new `.gitlab-ci.yml` is a **superset** of the existing pipeline - all lint/test/security stages preserved.

---

## Part 4: Docker Distribution

### Image Strategy

| Aspect | Choice | Rationale |
|--------|--------|-----------|
| Base Image | `python:3.10-slim` | Minimal attack surface |
| Build | Multi-stage | ~150MB vs ~800MB |
| User | Non-root (`nonroot:nonroot`) | Security best practice |
| Platforms | `linux/amd64`, `linux/arm64` | Support x86 and Apple Silicon |
| Transport | stdio | MCP standard for containers |

### Docker Usage

```bash
# Pull from Docker Hub
docker pull universalamateur/reclaim-mcp-server:latest

# Run with API key
docker run -e RECLAIM_API_KEY="your_key" universalamateur/reclaim-mcp-server

# Run with tool profile
docker run -e RECLAIM_API_KEY="your_key" -e RECLAIM_TOOL_PROFILE=minimal \
    universalamateur/reclaim-mcp-server
```

### Claude Desktop Configuration (Docker)

```json
{
  "mcpServers": {
    "reclaim": {
      "command": "docker",
      "args": [
        "run", "-i", "--rm",
        "-e", "RECLAIM_API_KEY",
        "universalamateur/reclaim-mcp-server:latest"
      ],
      "env": {
        "RECLAIM_API_KEY": "your_key_here"
      }
    }
  }
}
```

### Security Hardening Checklist

- [x] Multi-stage build (no build tools in runtime)
- [x] Non-root user
- [x] Minimal base image (python:slim)
- [x] No shell access needed
- [x] Health check endpoint
- [x] Multi-platform support (amd64/arm64)
- [ ] Future: Distroless base image (v0.9.0)
- [ ] Future: Image signing with Cosign (v0.9.0)

---

## Files to Modify

| File | Change |
|------|--------|
| `src/reclaim_mcp/config.py` | Add `tool_profile` field |
| `src/reclaim_mcp/profiles.py` | **CREATE** - profile definitions |
| `src/reclaim_mcp/server.py` | Conditional tool registration |
| `Dockerfile` | **COPY** from publishing repo |
| `.dockerignore` | **COPY** from publishing repo |
| `.gitlab-ci.yml` | **COPY** from publishing repo (replaces existing) |
| `README.md` | Add PyPI/Docker install, profile docs, badges |
| `pyproject.toml` | Version bump to 0.8.0 |
| `src/reclaim_mcp/__init__.py` | Version bump |
| `tests/test_server.py` | Version assertion update |
| `tests/test_profiles.py` | **CREATE** - profile tests |

---

## Order of Operations

### Phase 0: One-Time Setup (Before First Release)

1. **Create accounts** (if not existing)
   - PyPI with 2FA: https://pypi.org/account/register/
   - TestPyPI with 2FA: https://test.pypi.org/account/register/
   - DockerHub: https://hub.docker.com/signup

2. **Configure PyPI Trusted Publishers** (both PyPI and TestPyPI)
   | Field | Value |
   |-------|-------|
   | Namespace | `universalamateur1` |
   | Project | `reclaim-mcp-server` |
   | Workflow file path | `.gitlab-ci.yml` |
   | Environment | `release` (PyPI) / `release-test` (TestPyPI) |

3. **Add GitLab CI/CD Variables**
   - `DOCKERHUB_USERNAME` (protected)
   - `DOCKERHUB_TOKEN` (protected, masked)

4. **Create GitLab Environments**
   - `release-test`, `release`, `docker`

5. **Create DockerHub repository**
   - Name: `reclaim-mcp-server`, Visibility: Public

### Phase 1: Tool Profiles

1. Create `profiles.py` with tool profile definitions
2. Update `config.py` with `tool_profile` setting
3. Update `server.py` for conditional registration
4. Add tests for profile loading

### Phase 2: Copy Implementation Files

5. Copy `Dockerfile` from publishing repo
6. Copy `.dockerignore` from publishing repo
7. Copy `.gitlab-ci.yml` from publishing repo (replaces existing)
8. Test Docker build locally

### Phase 3: Documentation & Version

9. Update README with PyPI/Docker install, profile docs
10. Bump version to 0.8.0 (4 locations + poetry lock)
11. Run full test suite and linting

### Phase 4: Release

12. Commit and push to main
13. Create and push tag `v0.8.0`
14. Trigger publish jobs manually in GitLab UI:
    - `publish-testpypi` → verify → `publish-pypi`
    - `publish-gitlab-container` → `publish-dockerhub`

### Phase 5: Verification

15. Verify all registries:
    - [ ] TestPyPI: `pip install -i https://test.pypi.org/simple/ reclaim-mcp-server`
    - [ ] PyPI: `pip install reclaim-mcp-server`
    - [ ] GitLab Package Registry
    - [ ] GitLab Container Registry
    - [ ] DockerHub: `docker pull universalamateur/reclaim-mcp-server`

16. Submit to Smithery/Glama

---

## Testing

### Profile Tests

1. Unit tests for profile loading in `tests/test_profiles.py`
2. Verify each profile loads correct number of tools (20/33/42)
3. Test with `RECLAIM_TOOL_PROFILE=minimal` env var
4. Test invalid profile falls back to `full`

### Docker Tests

1. Build image locally: `docker build -t reclaim-mcp-server:test .`
2. Verify non-root user: `docker run reclaim-mcp-server:test whoami` → `nonroot`
3. Test with API key: `docker run -e RECLAIM_API_KEY=test reclaim-mcp-server:test`
4. Verify image size is reasonable (< 200MB target)

### Pipeline Tests

1. Test release jobs with RC tag (e.g., `v0.8.0-rc1`)
2. Verify TestPyPI before production PyPI

---

## Reference Documentation

- Expert recommendations: `/Users/falko/git-personal/reclaim-mcp-publishing/RECOMMENDATION.md`
- Full implementation guide: `/Users/falko/git-personal/reclaim-mcp-publishing/MULTI_REGISTRY_PUBLISHING_GUIDE.md`
